
## Introduction 

In the analysis of high-throughput big genomic sequencing data, it is required to write custom scripts to form the glue between tools or to perform specific analysis tasks. All Squeegeeing data are big size in nature, handling and pre/processing these data required high computing processing power. Generally, most of the tasks are carried out in the computer cluster. Various processing steps are required in order to get the final matrix form of the data for further downstream analysis. The easiest way to install this software is via [Bioconda](https://bioconda.github.io/).

The sequence analysis pipeline involves the below steps.

1. Quality assessment of sequencing data
2. Mapping reads onto a reference genome
3. Quantification and normalization
4. Downstream analysis (Statistic and Machine learning approach)
5. Report and Visualization

Multiple scripting languages are required for complete the genomics sequence analysis, for bioinformatic/sequence analysis Bash and R/biconductor language is reported here and Matlab for mathematical modeling.


## Quality assement of sequencing data 

Most sequencer machines generate a QC report as a part of their analysis pipeline, however, the focal point of the problems generated by the sequencer itself. Different bioinformatics tool aims to provide the information or spot the problem which originates either in the sequencer or in the starting experimental library material. A widely used tool is FastQC. It is performed by a series module and generates an HTML output evaluating pass/ fail results. The different analysis modules namely Basic Statistics, Per Base Sequence Quality, Per Sequence Quality Scores, Per Base Sequence Content, Per Base GC Content, Per Sequence GC Content, Per Base N Content, Sequence Length Distribution, Duplicate Sequences, Overrepresented Sequences, Overrepresented Kmers. Command-line can be used as (fastqc .fastq.gz*) for generating reports. More details of the module can be found [FastQC](https://www.bioinformatics.babraham.ac.uk/projects/fastqc/).


#### Adapter Remove 

Illumina adapter and other technical sequences are performed by TruSeq2 and TruSeq3 (as used by HiSeq and MiSeq machines)
for both single-end and paired-end modes. Depending on specific issues which may occur in library preparation, other sequences may work better for a given data set. Therefore, generating some quality metrics for raw sequence data is necessary. Different tool used widely such as  [Cutadapt](https://cutadapt.readthedocs.io/), [Trimmomatic](https://github.com/usadellab/Trimmomatic), [Flexbar](https://github.com/seqan/flexbar). Below bash script for Flexbar for trimming raw data. 

````
#!/bin/bash
#PBS -N trim_data
##PBS -j oe
#PBS -m e
#PBS-l mem=100G
#PBS -l walltime=50:13:59
#PBS -l nodes=1:ppn=8   
#PBS -e ./trim_data_$PBS_JOBID.err       
#PBS -o ./trim_data_$PBS_JOBID.out
#PBS -V
#echo $PBS_JOBNAME
#echo $PBS_JOBID
name=$1
data=~/raw_data
trim_data=~/raw_data
flexbar -r ${data}/${name}_1.fq -p ${data}/${name}_2.fq -t ${trim_data}/$(name) - 10 -z BZ2 -m 30 -u 0 -q 28 -a ${data}/Adapter.fa -f sanger

````

## Mapping reads onto a reference genome 

The initial process of sequencing analysis is (Alignment) which involved mapping the reads to the reference genome. This gives the precise location in the genome of each base pair in each sequencing read comes from. Further, mapped reads can be used to identify genetic variation and the genotypes of individuals at different locations in the genome (Variant calling ->Variant Annotation ->Visualization) using [bcftools](https://samtools.github.io/bcftools/bcftools.html), [VEP](https://www.ensembl.org/info/docs/tools/vep/index.htm),[IGV] (https://software.broadinstitute.org/software/igv/). This pipeline is typically used in whole-genome sequence analysis. Additionally, if the data are chip-sequencing the mapped read is used to identify the read distribution profile (Peak calling -> Peak annotation ->Peak visualization).
Different tools are used for the analysis such as [MACS2](https://samtools.github.io/bcftools/), [HOMER](http://homer.ucsd.edu/homer/ngs/peaks.html), [Bedtools](https://bedtools.readthedocs.io/en/latest/), [samtools](http://samtools.sourceforge.net/), [bamtools](https://github.com/pezmaster31/bamtools).
For RNA sequencing, mapped reads are further quantified as counted per gene. Gene-level count datasets for downstream analysis such as exploratory data analysis (EDA) for quality assessment and to explore the relationship between samples, differential gene expression analysis, and visualization of the results. Various software tools are used for alignment to reference the genome. Few names are outlined here, [hisat2](http://ccb.jhu.edu/software/hisat2/), [BWA](http://bio-bwa.sourceforge.net/bwa.shtml), [Bowtie](http://bowtie-bio.sourceforge.net/index.shtml), [subread](http://subread.sourceforge.net/), [STAR](https://github.com/alexdobin/STAR). Below script used for STAR alignment, the upper part of the script is used for indexing the reference genome, later part of the script is used for mapping the raw data. 

#### Align to Reference Genome

```
#!/bin/bash
#PBS -N Star_alignment
##PBS -j oe
#PBS -m e
#PBS-l mem=100G
#PBS -l walltime=50:13:59
#PBS -l nodes=1:ppn=8   
#PBS -e ./Star_alignment_$PBS_JOBID.err       
#PBS -o ./Star_alignment_$PBS_JOBID.out
#PBS -V
#echo $PBS_JOBNAME
#echo $PBS_JOBID
name=$1
ref_genome=~/genome_fold
data=~/raw_data
out=~/alignment
# Script to generate the genome index
STAR --runThreadN 8 \
--runMode genomeGenerate \
--genomeDir ${ref_genome} \
--genomeFastaFiles ${ref_genome} reference.fa \
--sjdbGTFfile ${ref_genome} reference.gtf \
--genomeSAindexNbases 6
--sjdbOverhang 99
# After genome indices generated,read alignment can be perfomed
STAR --runThreadN 8 --genomeDir ${ref_genome} --sjdbGTFfile ${ref_genome}/reference.gtf \
--readFilesCommand zcat \
--readFilesIn ${data}/${name}_1.fastq.gz ${data}/${name}_2.fastq.gz \
--outSAMtype BAM SortedByCoordinate \
--outSAMunmapped Within \
--outSAMattributes Standard 
--outFileNamePrefix ${out}/${name} \
--quantMode ${name}_GeneCounts

```

## Quantification and normalization

Alignments mapped read is counted using [Cufflinks](http://cole-trapnell-lab.github.io/cufflinks/), [eXpress](https://pachterlab.github.io/eXpress/overview.html), [HTSeq](https://htseq.readthedocs.io/en) using both the Intersection-Strict and the Union approaches, [RSEM](https://github.com/deweylab/RSEM), [featureCounts](http://subread.sourceforge.net/featureCounts.html) and [Stringtie](https://ccb.jhu.edu/software/stringtie/). There are some methods do not consider the classical alignment process and carry out alignment, counting and normalization in one single step such as [Kallisto](https://pachterlab.github.io/kallisto/), [Sailfish](https://www.cs.cmu.edu/~ckingsf/software/sailfish/), [Salmon](https://combine-lab.github.io/salmon/getting_started/)
Further, gene expression values are represented using the normalization techniques provided by each algorithm in R/Bioconductor: Transcripts per Million (TPM), Fragments per Kilobase of Mapped reads (FPKM), Trimmed Mean of M values (TMM from edgeR), Relative Log Expression (RLE from DESeq2). 

```
#!/bin/bash
#PBS -N htseq
##PBS -j oe
#PBS -m e
##PBS -l file=100GB
#PBS-l mem=100G
#PBS -l walltime=50:13:59
#PBS -l nodes=1:ppn=8   
#PBS -e ./htseq_$PBS_JOBID.err           # stderr file
#PBS -o ./htseq_$PBS_JOBID.out
#PBS -V
#echo $PBS_JOBNAME
#echo $PBS_JOBID
name=$1
gtf=~/genome
out=~/alignment
data=~/count
htseq-count -f bam \
-r pos \
--type=exon --idattr=gene_id \
--stranded=reverse \
--mode=intersection-nonempty \
${input}/${name}_accepted_hits.bam \
${gtf}/Reference.gtf >${output}/${name}.htseq_count.txt
```

## Down stream analysis (Statistic and Machine learning approach)

A primary objective of many gene expression experiments is to detect transcripts showing differential expression across various conditions.
Downstream analyses with RNA-Seq data include testing for differential expression between samples condition, cluster analysis of selected genes and samples, detecting condition gene-specific expression, GO, signaling pathway analysis (functional enrichment analysis and Network Construction), Dimensional reduction approach for data visualization, identifying novel genes and exons and novel splice junctions, ability to detect gene fusion events.
The below code demonstrates some of the key aspects of RNA sequence downstream analysis.

```
##############################################################################
Load require Library,or installed.packages('name of the pkg')
#############################################################################

library(DESeq2)
library(biomaRt)
library(gage)
library(gageData)
library(org.Mm.eg.db)
library(reshape2)
library(dplyr)

###############################################################################
Load the meta file, meta file contain tab separated sample infomration 
################################################################################

setwd("~/Desktop/Data")
meta<-read.delim("meta_data.txt",header=T,sep="\t")
meta<-read.delim("meta.txt",header = T,sep="\t")
sampleTable <- data.frame(sampleName = meta$sampleNames, fileName = meta$sampleFiles, condition = meta$sampleCondition)
DESeq2Table <- DESeqDataSetFromHTSeqCount(sampleTable = sampleTable,directory = ".",design = ~ condition)


####################################################################################
Data visulation by PCA plot
####################################################################################

DESeq2::plotPCA(vsd, intgroup=c("condition"),ntop=1000)
dev.copy2pdf(file='PCA_plot.pdf')
ddsHTSeq <- DESeq(DESeq2Table)
##Comparison conditions between two sample group  
res <- results(ddsHTSeq, contrast=c("condition", "Sample1", "Sample2"))
##Select significant Diffrential regulated gene
resSig <- subset(res, padj < 0.01)

########################################################################################################################
Annotate Ensembl id to gene symbol,gene biotype and entrezgene by biomart here mouse name taken as an example"
########################################################################################################################

resSig$ensembl <- sapply(strsplit(rownames(resSig), split="\\+" ), "[", 1 )
ensembl = useMart( "ensembl", dataset = "mmusculus_gene_ensembl")
genemap <- getBM( attributes = c("ensembl_gene_id","mgi_symbol","entrezgene","gene_biotype"),filters = "ensembl_gene_id",values = resSig$ensembl,mart = ensembl)
idx <- match(resSig$ensembl, genemap$ensembl_gene_id)
resSig$name <- genemap$mgi_symbol[idx]
resSig$gene <- genemap$entrezgene[idx]
resSig$gene_biotype <- genemap$gene_biotype[idx]
resSig$symbol <- genemap$name_1006[idx]

############################################################################################
Remove noncoding genes from the data
###############################################################################################

idx<-grep("protein_coding", resSig$gene_biotype, fixed = TRUE)
resSig<-resSig[idx,]
resOrdered <- resSig[order(-resSig$log2FoldChange ),]
write.xlsx(data.frame(resOrdered), "DEG_list.xlsx",asTable = TRUE,row.names=T)

#########################################################################################################
GO pathways analysis using GAGE Here all gene expression used unlike only DE gene, here data normalized 
########################################################################################################

GeneCounts <- counts(DESeq2Table)
cnts<-GeneCounts
sel.rn=rowSums(cnts) != 0
cnts=cnts[sel.rn,]
dim(cnts)
libsizes=colSums(cnts)
size.factor=libsizes/exp(mean(log(libsizes)))#cnts.norm=t(t(cnts)/size.factor)
range(cnts.norm)
cnts.norm=log2(cnts.norm+1)
range(cnts.norm)

#####################################################################################################################################
Make a GO term list from "org.Mm.eg.db" a mouse annotation package from bioconductor but you can also download "Misgdatabase"
or any other sourcse of the data base can be useed such as KEGG, reactome, consesuspathDB etc.
#######################################################################################################################################

mygo <- as.list(org.Mm.egGO2EG)
mygo <- (mygo[!is.na(mygo)])
t <- mget(names(mygo),GOTERM)
names(mygo) <- as.character(lapply(t,Term))

########################################################################################################################
Obtain Significance pathways using gage, gage uses t-test between two condition and listed up and down Go/pathway
#########################################################################################################################
gos <- gage(mymat,gsets = mygo,ref=ref,samp=samp,compare ="paired")
gene_set<-sigGeneSet(gos,cutoff=0.001)
up<-(gene_set$greater)
write.csv(up,file="go_upregulated.csv")
down<-(gene_set$less)
write.csv(down,file="go_downregulated.csv")

########################################################################################################################
only with differentially regulated gene based on fold change 
########################################################################################################################
foldchanges = resSig$log2FoldChange
names(foldchanges) = resSig$ensembl
keggres = gage(foldchanges, gsets=mygo, same.dir=TRUE)
lapply(keggres, head)

```

## Single cell sequencing analysis pipeline

Single-cell transcriptomics determines the gene expression level of individual cells by simultaneously measuring the messenger RNA (mRNA) concentration of hundreds to thousands of genes. It allows the studying of new biological questions in which cell-specific changes in transcriptome are important, e.g. heterogeneity of cell responses, cell type identification, inference of gene regulatory networks across the cells. There are also commercial platforms available for single-cell sequencing, 10X Genomics chromium platform widely used in the present day.
Most computational analysis methods from bulk RNA-seq can be used for the analysis of single-cell sequencing. In most cases, computational analysis requires adaptation of the existing methods or the development of new ones.
Here, analysis code is demonstrated for the 10x genomics chromium platform. The analysis pipeline typically starts as bulk RNA.  
[Cell Ranger](https://support.10xgenomics.com/single-cell-gene-expression/software/pipelines/latest/using/tutorial_in) software used for the single-cell pre-processing analysis. It integrates several tools and reported the count matrix as an output. 

##### Alignemnt and gene count

```
#!/bin/bash
#PBS -N cell_ranger
#PBS -j oe 
##PBS -l file=32GB
#PBS-l mem=100G
#PBS -l walltime=50:13:59
#PBS -l nodes=1:ppn=8	
#PBS -o ./cell_ranger_$PBS_JOBID.out
#PBS -e ./cell_ranger_$PBS_JOBID.err
echo $PBS_JOBID
echo $PBS_JOBNAME
cd $PBS_O_WORKDIR

#echo "=========================================================="
#echo "Starting on : $(date)"
#echo "Running on node : $(hostname)"
#echo "Current directory : $(pwd)"
#echo "Current job ID : $JOB_ID"
#echo "Current job name : $JOB_NAME"
#echo "Task index number : $SGE_TASK_ID"
#echo "=========================================================="

genome=~/genome/Ref_genome
data=~/single_cell/fastqs
name=$1

##### Downlaod the Refernce genome from ensembl(example mouse) and fileter all gene only keep protein biotype before mapping the sequnce data
wget ftp://ftp.ensembl.org/pub/release-93/fasta/mus_musculus/dna/Mus_musculus.GRCm38.dna.primary_assembly.fa.gz
gunzip Mus_musculus.GRCm38.dna.primary_assembly.fa.gz

wget ftp://ftp.ensembl.org/pub/release-93/gtf/mus_musculus/Mus_musculus.GRCm38.93.gtf.gz
gunzip Mus_musculus.GRCm38.93.gtf.gz

gn=~/genome/10x_genome
cellranger mkgtf ${gn}/Refernce.gtf Reference.filtered.gtf \
--attribute=gene_biotype:protein_coding \
--attribute=gene_biotype:lincRNA \
--attribute=gene_biotype:antisense \
--attribute=gene_biotype:IG_LV_gene \
--attribute=gene_biotype:IG_V_gene \
--attribute=gene_biotype:IG_V_pseudogene \
--attribute=gene_biotype:IG_D_gene \
--attribute=gene_biotype:IG_J_gene \
--attribute=gene_biotype:IG_J_pseudogene \
--attribute=gene_biotype:IG_C_gene \
--attribute=gene_biotype:IG_C_pseudogene \
--attribute=gene_biotype:TR_V_gene \
--attribute=gene_biotype:TR_V_pseudogene \
--attribute=gene_biotype:TR_D_gene \
--attribute=gene_biotype:TR_J_gene \
--attribute=gene_biotype:TR_J_pseudogene \
--attribute=gene_biotype:TR_C_gene

#########Genome indexing 
cellranger mkref --genome=mm10 \
--fasta=${gn}/Refernce.fa \
--genes=${gn}/Refernce.gtf \
--ref-version=3.0.0

################# Gene count  
cellranger count --chemistry=SC3Pv3 \
--id=${name}-REX --project=P180721 \
--transcriptome=${gn} \
--fastqs=${data} \
--sample=${name} \
--localcores=7 \
--expect-cells=500
--localmem=128

##############
library(Seurat)
library(dplyr)
library(Matrix)
library(cowplot)
library(patchwork)
library(RaceID)
library(openxlsx)
###################################################################
Load data in to R
####################################################################
BM <- CreateSeuratObject(counts =BM_data, project = "BoneMetastasis", min.cells =3,min.features = 200)
###################################################################
Filter specific cell marker 
###################################################################
BM<-subset( BM, subset = PECAM1>0.5)
BM <-SCTransform(BM)
############################################################
top10 <- head(VariableFeatures(BM), 10)
plot1 <- VariableFeaturePlot(BM)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2
dev.copy2pdf(file="variable_plot.pdf")

##########################################################################
Run PCA 
##################################################################
BM <- JackStraw(BM, num.replicate = 100)
JackStrawPlot(BM, dims = 1:50)
dev.copy2pdf(file="JackStra_plot.pdf")
ElbowPlot(BM)
dev.copy2pdf(file="elbow_plot.pdf")

BM  <- RunPCA(BM , features = VariableFeatures(object = BM ))
BM  <- RunUMAP(BM , dims = 1:25, verbose = F)
BM <- FindNeighbors(BM , dims = 1:25, verbose = F)
BM<- FindClusters(BM, resolution = 0.4)


#############################################################################################################
FIND MARKER GENES list and theier count matrix
#############################################################################################################
all.markers <- FindAllMarkers(BM, only.pos = TRUE, min.pct = 0.25, logfc.threshold =0.5,return.thresh = 0.01)
write.xlsx(data.frame(all.markers),"all_cluster_marker_gene.xls",rownames=T)
write.table(as.matrix(GetAssayData(object = BM, slot = "counts")), 'counts.csv', sep = ',', row.names = T, col.names = T, quote = F)

################################################################################################################
PLOT GENE OF INTEREST 
################################################################################################################
features = c( "PECAM1",FLT4")
FeaturePlot(BM, features = features,ncol = 2)
dev.copy2pdf(file="feature_plot.pdf")

VlnPlot(BM,features = features,ncol = 2)
dev.copy2pdf(file="VINPOT.pdf")

DimPlot(BM, reduction = "umap",label = T)
dev.copy2pdf(file="umap.pdf")

pdf(file="gene_umap.pdf",width = 12,height = 6)
p1<-FeaturePlot(object = BM, features,ncol = 2)
p2<-DimPlot(BM, label = T)
CombinePlots(plots = list(p1, p2))
dev.off()
##############################################################################################
Anotate the cell type based on the top marker gene plot them 
#################################################################################
BM <- RenameIdents(object = BM, `0` = "Endothelial cell", 
                                `1` = "Tcell", 
                                `2` = "Macrophages", 
                                `3` = "Luminal cell", 
                                `4` = "B cells",
                                `5` = "Macrophages/MICell")
                              
pdf(file="pca_plot_with_cell_type.pdf",width = 10,height = 10)
DimPlot(BM , reduction = "pca")
dev.off()

pdf(file="label_umap_plot.pdf",width = 10,height = 10)
DimPlot(object = BM , label = TRUE)
dev.off()

pdf(file="label_tsne_plot.pdf",width = 10,height = 10)
TSNEPlot(object = BM)
dev.off()


###########################################################################################
GO/ PATHWAYS ANALYSIS OF SPECIFIC CLUSTER
###########################################################################################

clut<-all.markers[which(all.markers$cluster == "6"),]
all.gen <- subset(clut, p_val_adj< 0.001)
all.gen$geneid <- as.character(mget(rownames(all.gen),org.Hs.egSYMBOL2EG,ifnotfound=NA))
mygo <- as.list(org.Hs.egGO2EG)
mygo <- (mygo[!is.na(mygo)])
t <- mget(names(mygo),GOTERM)
names(mygo) <- as.character(lapply(t,Term))
deseq2.fc=all.gen$avg_log2FC
names(deseq2.fc)=all.gen$geneid
gos <- gage(deseq2.fc,gsets = mygo,ref = NULL, samp = NULL)
gene_set<-sigGeneSet(gos,cutoff=0.01)
up_path<-(gene_set$greater)
down_path<-(gene_set$less)

#############################################################################################
Kegg pathways analysis 
##############################################################################################
kg.hsa=kegg.gsets("hsa")
kg.hsa<-kegg.gsets(species = "hsa", id.type = "entrez")
kegg.gs=kg.hsa$kg.sets[kg.hsa$sigmet.idx]
kegg.gs=kg.hsa$kg.sets
gos <- gage(deseq2.fc,gsets=kegg.gs,ref = NULL, samp = NULL)
up<-(gene_set$greater)
write.csv(up,file="go_upregulated.csv")
down<-(gene_set$less)
write.csv(down,file="go_downregulated.csv")

